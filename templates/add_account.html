<!DOCTYPE html>
<html>
<head>
    <title>Add Account - XHS</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; text-align: center; }
        #qr-container { margin: 20px auto; min-height: 400px; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center; background: #fafafa; }
        /* Force image to be larger but responsive */
        #qr-image { max-width: 100%; min-width: 300px; width: auto; height: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .log-box { text-align: left; background: #f5f5f5; padding: 10px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.9em; margin-top: 20px; border-radius: 4px; }
        .btn { padding: 10px 20px; background-color: #ff2442; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1.1em; }
        .btn:disabled { background-color: #ccc; }
    </style>
</head>
<body>
    <h1>Add New Account</h1>
    <p>Click start, then scan the QR code with your Xiaohongshu App.</p>
    
    <button id="start-btn" class="btn" onclick="startLogin()">Start Login Process</button>
    
    <div id="status-text" style="margin: 15px 0; font-weight: bold; color: #555;">Ready</div>

    <div id="qr-container">
        <div id="placeholder">QR Code will appear here...</div>
        <img id="qr-image" style="display: none;" />
    </div>

    <div class="log-box" id="logs"></div>
    
    <div style="margin-top: 20px;">
        <a href="/">Back to Home</a>
    </div>

    <script>
        let pollInterval;

        // Auto-check status on load
        window.onload = function() {
             checkInitialStatus();
        };

        function checkInitialStatus() {
            fetch('/api/login_status')
                .then(res => res.json())
                .then(data => {
                    // If server is busy or waiting, resume polling immediately
                    if (data.status === 'initializing' || data.status === 'waiting_scan' || data.status === 'processing') {
                        console.log("Resuming session...");
                        document.getElementById('start-btn').disabled = true;
                        pollStatus();
                    }
                });
        }

        function startLogin() {
            document.getElementById('start-btn').disabled = true;
            document.getElementById('status-text').innerText = "Initializing browser...";
            
            fetch('/api/start_login', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if(data.status === 'started') {
                        pollStatus();
                    } else {
                        // If already busy, just poll
                        if (data.status === 'busy') {
                             pollStatus();
                        } else {
                            alert(data.message);
                            document.getElementById('start-btn').disabled = false;
                        }
                    }
                });
        }

        function pollStatus() {
            pollInterval = setInterval(() => {
                fetch('/api/login_status')
                    .then(res => res.json())
                    .then(data => {
                        // Update logs
                        const logBox = document.getElementById('logs');
                        logBox.innerHTML = data.logs.join('<br>');
                        logBox.scrollTop = logBox.scrollHeight;
                        
                        // Update Status
                        const statusEl = document.getElementById('status-text');
                        
                        if (data.status === 'waiting_scan') {
                            statusEl.innerText = "Please Scan QR Code Now!";
                            statusEl.style.color = "red";
                            if (data.qr_path) {
                                document.getElementById('placeholder').style.display = 'none';
                                const img = document.getElementById('qr-image');
                                img.src = data.qr_path + "?t=" + new Date().getTime(); // bust cache
                                img.style.display = 'block';
                            }
                        } else if (data.status === 'success') {
                            clearInterval(pollInterval);
                            statusEl.innerText = "Login Successful! Redirecting...";
                            statusEl.style.color = "green";
                            setTimeout(() => window.location.href = '/', 2000);
                        } else if (data.status === 'failed' || data.status === 'timeout') {
                            clearInterval(pollInterval);
                            statusEl.innerText = "Login Failed: " + data.message;
                            document.getElementById('start-btn').disabled = false;
                        } else {
                            statusEl.innerText = "Status: " + data.status;
                        }
                    });
            }, 2000);
        }
    </script>
</body>
</html>
